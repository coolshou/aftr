<!--
 - Copyright (C) 2009, 2010 Internet Systems Consortium, Inc. ("ISC")
 - 
 - Permission to use, copy, modify, and/or distribute this software for any
 - purpose with or without fee is hereby granted, provided that the above
 - copyright notice and this permission notice appear in all copies.
 - 
 - THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH
 - REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
 - AND FITNESS. IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,
 - INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
 - LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE
 - OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
 - PERFORMANCE OF THIS SOFTWARE.
-->
<!-- $Id$ -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Address Family Transition Router Manual</title>
<meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book" title="Address Family Transition Router Manual">
<div class="titlepage">
<div>
<div><h1 class="title">
<a name="id2417217"></a>Address Family Transition Router Manual</h1></div>
<div><p class="copyright">Copyright © 2009, 2010 Internet Systems Consortium, Inc. ("ISC")</p></div>
</div>
<hr>
</div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="chapter"><a href="#id2610228">1. INTRODUCTION</a></span></dt>
<dd><dl><dt><span class="sect1"><a href="#id2661584">1.1. Work in Progress</a></span></dt></dl></dd>
<dt><span class="chapter"><a href="#id2609363">2. GETTING STARTED</a></span></dt>
<dd><dl>
<dt><span class="sect1"><a href="#id2661789">2.1. Setting Up AFTR</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="#id2661794">2.1.1. System Requirements for AFTR</a></span></dt>
<dt><span class="sect2"><a href="#id2661550">2.1.2. Building AFTR</a></span></dt>
<dt><span class="sect2"><a href="#id2662836">2.1.3. Minimal AFTR Configuration</a></span></dt>
<dt><span class="sect2"><a href="#id2662934">2.1.4. AFTR Script</a></span></dt>
<dt><span class="sect2"><a href="#id2662994">2.1.5. Running AFTR</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="#id2663053">2.2. Setting Up B4</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="#id2663076">2.2.1. System Requirements for B4</a></span></dt>
<dt><span class="sect2"><a href="#id2663092">2.2.2. Building B4</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="#id2663222">2.3. Other Setup</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="#id2663227">2.3.1. DHCPv6 Configuration</a></span></dt>
<dt><span class="sect2"><a href="#id2663343">2.3.2. DNS Configuration</a></span></dt>
</dl></dd>
</dl></dd>
<dt><span class="chapter"><a href="#id2663434">3. AFTR MANUAL</a></span></dt>
<dd><dl>
<dt><span class="sect1"><a href="#id2663440">3.1. Compile Flags</a></span></dt>
<dt><span class="sect1"><a href="#id2663607">3.2. Command Line Options</a></span></dt>
<dt><span class="sect1"><a href="#id2663633">3.3. Configuration File</a></span></dt>
<dt><span class="sect1"><a href="#id2663655">3.4. Interactive Commands</a></span></dt>
<dt><span class="sect1"><a href="#id2663677">3.5. Command Summary</a></span></dt>
</dl></dd>
<dt><span class="chapter"><a href="#id2664294">4. Managing AFTR</a></span></dt>
<dd><dl>
<dt><span class="sect1"><a href="#id2664300">4.1. Syslog</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="#id2664407">4.1.1. Trace Logging</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="#id2664533">4.2. Security</a></span></dt>
<dt><span class="sect1"><a href="#id2664579">4.3. Debug primer</a></span></dt>
</dl></dd>
<dt><span class="chapter"><a href="#id2664747">5. XML Interface</a></span></dt>
<dd><dl>
<dt><span class="sect1"><a href="#id2664778">5.1. Transport</a></span></dt>
<dt><span class="sect1"><a href="#id2664808">5.2. Remote Configuration Daemon</a></span></dt>
<dt><span class="sect1"><a href="#id2664830">5.3. Remote Configuration Client</a></span></dt>
</dl></dd>
<dt><span class="chapter"><a href="#id2664853">6. Advanced Topics</a></span></dt>
<dd><dl>
<dt><span class="sect1"><a href="#id2664858">6.1. No-Nat/Pass-Through</a></span></dt>
<dt><span class="sect1"><a href="#id2664921">6.2. A+P/Port-Range Routing</a></span></dt>
<dt><span class="sect1"><a href="#id2664989">6.3. Sharing a Single Address</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="#id2665142">6.3.1. For netfilter/iptables Wizards</a></span></dt></dl></dd>
</dl></dd>
<dt><span class="appendix"><a href="#id2662490">A. Mailing Lists</a></span></dt>
</dl>
</div>
<div class="list-of-tables">
<p><b>List of Tables</b></p>
<dl><dt>3.1. <a href="#id2663685"></a>
</dt></dl>
</div>
<div class="chapter" title="Chapter 1. INTRODUCTION">
<div class="titlepage"><div><div><h2 class="title">
<a name="id2610228"></a>Chapter 1. INTRODUCTION</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl><dt><span class="sect1"><a href="#id2661584">1.1. Work in Progress</a></span></dt></dl>
</div>
<p>
      ISC AFTR implements a Dual-Stack Lite (DS-Lite) Address Family
      Transition Router (<acronym class="acronym">AFTR</acronym>), as described in
      <code class="filename">draft-ietf-softwire-dual-stack-lite-06.txt</code>.
      This technology allows end-users with IPv4-only hosts or
      IPv4-only applications to communicate with IPv4 peers over an
      IPv6-only network.
    </p>
<p>
      A DS-Lite deployment includes at least one AFTR in the ISP's
      network core, and one Basic Bridging BroadBand element
      (<acronym class="acronym">B4</acronym>) at each customer premises.
    </p>
<div class="sect1" title="1.1. Work in Progress">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2661584"></a>1.1. Work in Progress</h2></div></div></div>
<p>
         DS-Lite is in the process of being standardized by the
         Softwire working group of the IETF.  ISC AFTR actively tracks
         the current specification, but users should be aware that
         there may be changes to the specification before it is
         finalized as an RFC.  As such, this should be considered a
         work in progress, for testing and experimentation only.
       </p>
</div>
</div>
<div class="chapter" title="Chapter 2. GETTING STARTED">
<div class="titlepage"><div><div><h2 class="title">
<a name="id2609363"></a>Chapter 2. GETTING STARTED</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="#id2661789">2.1. Setting Up AFTR</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="#id2661794">2.1.1. System Requirements for AFTR</a></span></dt>
<dt><span class="sect2"><a href="#id2661550">2.1.2. Building AFTR</a></span></dt>
<dt><span class="sect2"><a href="#id2662836">2.1.3. Minimal AFTR Configuration</a></span></dt>
<dt><span class="sect2"><a href="#id2662934">2.1.4. AFTR Script</a></span></dt>
<dt><span class="sect2"><a href="#id2662994">2.1.5. Running AFTR</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="#id2663053">2.2. Setting Up B4</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="#id2663076">2.2.1. System Requirements for B4</a></span></dt>
<dt><span class="sect2"><a href="#id2663092">2.2.2. Building B4</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="#id2663222">2.3. Other Setup</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="#id2663227">2.3.1. DHCPv6 Configuration</a></span></dt>
<dt><span class="sect2"><a href="#id2663343">2.3.2. DNS Configuration</a></span></dt>
</dl></dd>
</dl>
</div>
<p>
      This section provides a "quick start" to using ISC AFTR in the
      simplest configuration.  For full build and configuration
      details, see chapter 3.
    </p>
<div class="sect1" title="2.1. Setting Up AFTR">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2661789"></a>2.1. Setting Up AFTR</h2></div></div></div>
<div class="sect2" title="2.1.1. System Requirements for AFTR">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2661794"></a>2.1.1. System Requirements for AFTR</h3></div></div></div>
<p>
          </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p>
                OS: Linux or FreeBSD.  Kernel must be built with IPv6
                and <span class="refentrytitle">tun</span>(4).
              </p>
<p>
                Linux kernel version must be greater than 2.6.26, to
                correct a small-packet-drop problem in
                <code class="function">tunnel46_rcv()</code>.
              </p>
</li>
<li class="listitem"><p>
                CPU: No special requirement.  Note that performance is
                bound to the kernel/user context switch latency, so
                processor speed is the single biggest determiner of
                performance.
              </p></li>
<li class="listitem"><p>
                Memory: No special requirement.
              </p></li>
</ul></div>
<p>
        </p>
</div>
<div class="sect2" title="2.1.2. Building AFTR">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2661550"></a>2.1.2. Building AFTR</h3></div></div></div>
<p>
          Unpack the distribution.
        </p>
<p>
          <strong class="userinput"><code>tar zxvpf aftr-1.1.tar.gz</code></strong>
        </p>
<p>
          This creates a a directory named <code class="filename">aftr-1.1</code>,
          which we refer to as <code class="varname">$src_path</code> hereafter.
        </p>
<p>
          <strong class="userinput"><code>cd $src_path</code></strong><br>
          <strong class="userinput"><code>./configure</code></strong><br>
          <strong class="userinput"><code>make</code></strong>
        </p>
<p>
          This creates an executable file <code class="filename">aftr</code>,
          which is the AFTR daemon program.  It is expected to be run
          in the same directory as the configuration
          file <code class="filename">aftr.conf</code> and the script
          file <code class="filename">aftr-script</code> (there is
          no <strong class="userinput"><code>make install</code></strong> step).
        </p>
</div>
<div class="sect2" title="2.1.3. Minimal AFTR Configuration">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2662836"></a>2.1.3. Minimal AFTR Configuration</h3></div></div></div>
<p>
          An example <code class="filename">aftr.conf</code> file is located in
          the <code class="filename">conf</code> directory.
        </p>
<p>
          The only required parameters are those in section 1 of the
          config file, and are briefly described here.  The full set
          of configuration commands is described in section 3.3.
        </p>
<p>
          <strong class="userinput"><code>address endpoint 2001::1</code></strong>
        </p>
<p>
          This is the IPv6 address of the AFTR.  Specifically, it is the
          endpoint of the IPv6 tunnel between the B4 and the AFTR.
        </p>
<p>
          This address is associated with the tunnel interface, but is
          not explicitly assigned to it; instead, the
          <code class="function">aftr-start()</code> portion of the script file
          creates a covering route to the tunnel interface.
        </p>
<p>
          <strong class="userinput"><code>address icmp 192.0.0.1</code></strong>
        </p>
<p>
          This is a global IPv4 address used as the source for ICMP errors
          sent from the AFTR to the Internet.  The actual address doesn't
          matter, as no one should try to respond to an ICMP packet.
        </p>
<p>
          <strong class="userinput"><code>acl6 2001::/48</code></strong>
        </p>
<p>
          This is an Access Control List for IPv6 traffic from the B4 to the
          AFTR.  It is the IPv6 prefix that encloses the portion of the
          provider's network that is served by this AFTR.  If the AFTR serves
          customers served by multiple disjoint IPv6 prefixes, there can be
          multiple <span class="command"><strong>acl6</strong></span> commands.
        </p>
<p>
          <strong class="userinput"><code>pool 198.18.200.1</code></strong>
        </p>
<p>
          This is a global IPv4 address in the service provider's
          network, which will be used as the NATted address for
          packets sent to the Internet.
        </p>
<p>
          Multiple pool addresses may be defined, and restrictions may
          be placed on port ranges to use for NAT bindings.
        </p>
</div>
<div class="sect2" title="2.1.4. AFTR Script">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2662934"></a>2.1.4. AFTR Script</h3></div></div></div>
<p>
          The <span class="command"><strong>aftr</strong></span> executable requires a
          startup/shutdown script.  When <span class="command"><strong>aftr</strong></span>
          starts up, it calls the script's <code class="function">start</code>
          function to bring up the tunnel interface, and set up routes
          to the interface.
        </p>
<p>
          When <span class="command"><strong>aftr</strong></span> shuts down, it calls the
          script's <code class="function">stop</code> function to bring down
          the tunnel interface, and remove all routes to the
          interface.
        </p>
<p>
          By default, the script file is
          named <code class="filename">aftr-script</code>, and resides in the
          same directory as the <code class="filename">aftr</code> executable
          file.
        </p>
<p>
          The <code class="filename">conf</code> directory contains example
          <code class="filename">aftr-script</code> files for Linux and FreeBSD.
        </p>
</div>
<div class="sect2" title="2.1.5. Running AFTR">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2662994"></a>2.1.5. Running AFTR</h3></div></div></div>
<p>
          First, make sure your interfaces are configured correctly,
          and IPv4 and IPv6 forwarding are enabled.  On Linux, you may
          also want to disable <span class="command"><strong>netfilter</strong></span>
          for performance reasons.
        </p>
<p>
          Note: Linux 
          netfilter tables need to be flushed ('<strong class="userinput"><code>iptables
          -F</code></strong>' and '<strong class="userinput"><code>ip6tables -F</code></strong>')
          explicitly.
        </p>
<p>
          To start AFTR, run the <code class="filename">aftr</code> executable
          in the same directory as the <code class="filename">aftr.conf</code>
          configuration file and the
          <code class="filename">aftr-script</code> script file.  For other
          startup options, see section 3.2.
        </p>
<p>
          AFTR normally starts as a daemon process.  To access the
          control interface, <span class="command"><strong>telnet</strong></span> to localhost
          port 1015.  AFTR can also be started in foreground mode,
          which gives immediate access to the control interface.  For
          control commands, see section 3.4.
        </p>
</div>
</div>
<div class="sect1" title="2.2. Setting Up B4">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2663053"></a>2.2. Setting Up B4</h2></div></div></div>
<p>
        The B4 is the customer-side DS-Lite tunnel initiator.  In the
        most common use case, it is a home gateway, also referred to
        as a CPE (Customer Premises Equipment).
      </p>
<p>
        For testing and demonstration purposes, we have used home
        gateways (e.g., Linksys WRT54GL) running OpenWrt, a Linux
        distribution tailored for home gateways and related devices.
        B4 functionality can also be built into general-purpose
        computers, and has been demonstrated in FreeBSD and Ubuntu
        Linux.  In all of these cases, the important thing to keep in
        mind is that the B4 device is the IPv4 default router for all
        hosts behind it.
      </p>
<div class="sect2" title="2.2.1. System Requirements for B4">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2663076"></a>2.2.1. System Requirements for B4</h3></div></div></div>
<p>
          There are no special requirements above what one might
          expect for a home gateway.  The only added functionality
          that makes it a B4 is to set up an IPv4-in-IPv6 tunnel, and
          to encapsulate/decapsulate all IPv4 traffic to/from that
          tunnel; and all home gateways that can run OpenWrt can do
          that.
        </p>
</div>
<div class="sect2" title="2.2.2. Building B4">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2663092"></a>2.2.2. Building B4</h3></div></div></div>
<p>
          Note: More information, and prebuilt images for WRT54G
          devices, can be found at
          <code class="uri">http://www.kangaroo.comcast.net</code>
        </p>
<p>
          The following instructions are for building an OpenWrt image
          from sources.
        </p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>
              Get OpenWrt sources from
              <code class="uri">https://dev.openwrt.org</code>
            </p></li>
<li class="listitem"><p>
              Copy the contents of the
              <code class="filename">conf/b4-openwrt</code> directory to a new
              directory named
              openwrt/<em class="replaceable"><code>version</code></em>/package/dhcp4
            </p></li>
<li class="listitem">
<p>
              Go to the openwrt/<em class="replaceable"><code>version</code></em>
              directory, run <span class="command"><strong>make menuconfig</strong></span>, and
              make the following selections:
            </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
                  Select 2.6 kernel: Target System &gt; Broadcom
                  BCM947xx/953xx (or your target architecture)
                </p></li>
<li class="listitem"><p>
                  Deselect busybox udhcp client: Base system &gt;
                  busybox &gt; Configuration &gt; Networking Utilities
                </p></li>
<li class="listitem"><p>
                  Select dhcp4-client and dhcpv6: Network &gt; isc-dhcp
                </p></li>
<li class="listitem"><p>
                  Select the non-busybox version of
                  <span class="command"><strong>ip</strong></span>: Network &gt; ip
                </p></li>
<li class="listitem"><p>
                  Select ip6-tunnel: Kernel modules &gt; Network
                  Support &gt; kmod-ip6-tunnel
                </p></li>
</ul></div>
</li>
</ol></div>
</div>
</div>
<div class="sect1" title="2.3. Other Setup">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2663222"></a>2.3. Other Setup</h2></div></div></div>
<div class="sect2" title="2.3.1. DHCPv6 Configuration">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2663227"></a>2.3.1. DHCPv6 Configuration</h3></div></div></div>
<p>
          <code class="filename">draft-ietf-softwire-dual-stack-lite-06.txt</code>
          says:
        </p>
<div class="blockquote"><blockquote class="blockquote">
<p>
          In order to configure the IPv4-in-IPv6 tunnel, the B4
          element needs the IPv6 address of the AFTR element.  This
          IPv6 address can be configured using a variety of methods,
          ranging from an out-of-band mechanism, manual configuration
          or a variety of DHCPv6 options.
        </p>
<p>
          In order to guarantee interoperability, a B4 element SHOULD implement
          the DHCPv6 option defined in
          [I-D.ietf-softwire-ds-lite-tunnel-option].
        </p>
</blockquote></div>
<p>
          The DHCP server does not have to run on the same computer as
          the AFTR, but it must be reachable via normal DHCP request
          channels from the B4, and it must be configured with the
          AFTR address.
        </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p>
              On the server, add something like the following
              to <code class="filename">dhcpd6.conf</code>:
            </p>
<p>
              <strong class="userinput"><code>option dhcp6.dslite code 54 = ip6-address;<br>
                option dhcp6.dslite 2001::1;</code></strong>
            </p>
<p>
              NOTE: For testing, we use an unassigned DHCPv6 option code.
              DO NOT use this option code in production, as it is likely
              to change when the draft reaches RFC status.
            </p>
<p>
              The IPv6 address must be the same as the
              <strong class="userinput"><code>address endpoint</code></strong> option
              in <code class="filename">aftr.conf</code>.
            </p>
</li>
<li class="listitem">
<p>
              On the B4, <code class="filename">dhclient6.conf</code> contains the
              following to request the option:
            </p>
<p>
              <strong class="userinput"><code>option dhcp6.dslite code 54 = ip6-address;<br>
                also request dhcp6.dslite;</code></strong>
            </p>
<p>
              If you are using the supplied OpenWrt dhcp4 package,
              <code class="filename">dhclient6.conf</code> already contains these
              lines, and <code class="filename">dhclient-script</code> contains a
              few extra lines to set up the tunnel and create a default
              IPv4 route to it.
            </p>
</li>
</ul></div>
</div>
<div class="sect2" title="2.3.2. DNS Configuration">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2663343"></a>2.3.2. DNS Configuration</h3></div></div></div>
<p>
          <code class="filename">draft-ietf-softwire-dual-stack-lite-06.txt</code>
          recommends configuring the B4 with a DNS proxy resolver,
          which will forward queries to an external recursive server
          over IPv6 (this server may be co-located on the AFTR box).
        </p>
<p>
          To configure the B4 with an upstream resolver address, add something
          like the following to dhcpd6.conf:
        </p>
<p>
          <strong class="userinput"><code>option dhcp6.name-servers 3ffe:501:ffff:100:200:ff:fe00:3f3e;</code></strong>
        </p>
<p>
          Note: if the B4 uses <span class="command"><strong>dnsmasq</strong></span> as a DNS
          proxy, then the used version should be checked.  Only recent
          versions are RFC 5625 compliant; in particular the EDNS0 UDP
          size can be limited to 1280 bytes instead of the recommended
          4096 bytes.
        </p>
<p>
          It is easy to fix this last point by configuration:
        </p>
<p>
          </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p>
                Add in <code class="filename">/etc/config/dhcp</code> in the
                dnsmasq section the line:
              </p>
<p>
                <strong class="userinput"><code>option ednspacket_max 4096</code></strong>
              </p>
</li>
<li class="listitem">
<p>
                If <span class="command"><strong>dnsmasq</strong></span> is launched directly,
                add these arguments:
              </p>
<p>
                <strong class="userinput"><code>-P 4096</code></strong>
              </p>
</li>
</ul></div>
<p>
        </p>
</div>
</div>
</div>
<div class="chapter" title="Chapter 3. AFTR MANUAL">
<div class="titlepage"><div><div><h2 class="title">
<a name="id2663434"></a>Chapter 3. AFTR MANUAL</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="#id2663440">3.1. Compile Flags</a></span></dt>
<dt><span class="sect1"><a href="#id2663607">3.2. Command Line Options</a></span></dt>
<dt><span class="sect1"><a href="#id2663633">3.3. Configuration File</a></span></dt>
<dt><span class="sect1"><a href="#id2663655">3.4. Interactive Commands</a></span></dt>
<dt><span class="sect1"><a href="#id2663677">3.5. Command Summary</a></span></dt>
</dl>
</div>
<div class="sect1" title="3.1. Compile Flags">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2663440"></a>3.1. Compile Flags</h2></div></div></div>
<p>
         Here is the list of configuration flags
         (i.e., <code class="varname">CFLAGS</code>):
         </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">AFTRCONFIG</code>: config file path
             (default <code class="filename">aftr.conf</code>)</p></li>
<li class="listitem"><p><code class="varname">AFTRSCRIPT</code>: script file path
             (default <code class="filename">./aftr-script</code>)</p></li>
<li class="listitem"><p><code class="varname">AFTRDEVICE</code>: name of the interface/device
             (default <code class="filename">tun0</code>)</p></li>
<li class="listitem"><p><code class="varname">AFTRPORT</code>: port for TCP control channels
             (default 1015)</p></li>
<li class="listitem"><p><code class="varname">AFTRFACILITY</code>: syslog facility
             (default <code class="constant">LOG_LOCAL5</code>)</p></li>
<li class="listitem"><p><code class="varname">AFTRLOGOPTION</code>: openlog option
             (default <code class="constant">LOG_NDELAY</code>)</p></li>
<li class="listitem"><p><code class="varname">TRACE_NAT</code>: enable tracing of NAT
             entry creation/deletion (default is <code class="constant">undef</code>,
             i.e., only tunnels and buckets are traced)</p></li>
<li class="listitem"><p><code class="varname">NOPRIVACY</code>: trace all addresses and ports
             in NAT entry tracing (default is <code class="constant">undef</code>)
           </p></li>
<li class="listitem"><p><code class="varname">SIGNSHDR</code>: define it to add a signature
             header in structures (default is <code class="constant">undef</code>)
           </p></li>
<li class="listitem"><p><code class="varname">SIZES</code>: define it to print sizes of
             principal data structures (default is <code class="constant">undef</code>)
           </p></li>
<li class="listitem"><p><code class="varname">USE_TUN_PI</code>: use the tun_pi struct in tun
             interface/device I/O
             (required on some platforms, including RedHat and CentOS v5,
             for IPv6 support)</p></li>
<li class="listitem"><p><code class="varname">notyet</code>: some unfinished and arguable
             features (<code class="constant">undef</code> of course)</p></li>
</ul></div>
<p>
       </p>
</div>
<div class="sect1" title="3.2. Command Line Options">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2663607"></a>3.2. Command Line Options</h2></div></div></div>
<p>
         Included inline <span class="refentrytitle">aftr</span>
         (8)
       </p>
<div class="refentry" title="aftr">
<a name="man.aftr"></a><div class="titlepage"></div>
<div class="refnamediv">
<h2>Name</h2>
<p><span class="application">aftr</span> &#8212; Address Family Transition Router</p>
</div>
<div class="refsynopsisdiv" title="Synopsis">
<h2>Synopsis</h2>
<div class="cmdsynopsis"><p><code class="command">aftr</code>  [<code class="option">-g</code>] [<code class="option">-t</code>] [<code class="option">-c <em class="replaceable"><code>config-file</code></em></code>] [<code class="option">-d <em class="replaceable"><code>device-name</code></em></code>] [<code class="option">-p <em class="replaceable"><code>port-number</code></em></code>] [<code class="option">-s <em class="replaceable"><code>script-file</code></em></code>] [<code class="option">-u <em class="replaceable"><code>socket-name</code></em></code>]</p></div>
</div>
<div class="refsect1" title="OPTIONS">
<a name="id2667334"></a><h2>OPTIONS</h2>
<div class="variablelist"><dl>
<dt><span class="term">-g</span></dt>
<dd><p>
            By default the aftr process becomes a daemon,
            <code class="option">-g</code> keeps it in foreground with logging to stderr.
          </p></dd>
<dt><span class="term">-t</span></dt>
<dd><p>
            <code class="option">-t</code> can be used to check a configuration file.
          </p></dd>
<dt><span class="term">-c <em class="replaceable"><code>config-file</code></em></span></dt>
<dd><p>
            The <span class="command"><strong>aftr</strong></span> daemon requires a configuration file.
            By default it is named <code class="filename">aftr.conf</code>, and is
            located in <code class="varname">$src_path</code>.  The
            <code class="varname">AFTRCONFIG</code> environment
            variable and the <code class="option">-c</code> argument give an
            alternate path.  A sample configuration file is provided in
            <code class="filename">$src_path/conf/aftr.conf</code> (OS independent).
          </p></dd>
<dt><span class="term">-d <em class="replaceable"><code>device-name</code></em></span></dt>
<dd>
<p>
             Linux: The aftr process opens <code class="filename">/dev/net/tun</code>
             and set the name of the interface to the
             <code class="varname">AFTRDEVICE</code> environment
             variable or the <code class="option">-d</code> command line argument value
             or by default 'tun0'.
          </p>
<p>
            FreeBSD: The aftr process opens <code class="filename">/dev/tunXXX</code>
            from the <code class="varname">AFTRDEVICE</code> environment variable or
            the <code class="option">-d</code> command or by default
            <code class="filename">/dev/tun0</code>. The 'auto' value uses the first
            free <code class="filename">/dev/tunXXX</code> device.
          </p>
<p>
            The tunnel interface/device specification can be a full path
            (<code class="filename">/dev/...</code>), a relative name or a number.
          </p>
</dd>
<dt><span class="term">-p <em class="replaceable"><code>port-number</code></em></span></dt>
<dd><p>
            Use the <em class="replaceable"><code>port-number</code></em>
            for TCP control channels. Default is 1015.
          </p></dd>
<dt><span class="term">-s <em class="replaceable"><code>script-file</code></em></span></dt>
<dd>
<p>
            The <span class="command"><strong>aftr</strong></span> daemon executes a shell script file
            with <code class="option">start</code> on invocation.
            This is named by default <code class="filename">aftr-script</code> and
            located in <code class="varname">$src_path</code>. The
            <code class="varname">AFTRSCRIPT</code> environment variable and
            the <code class="option">-s</code> argument give
            an alternate path. This file could be even empty, but must exist.
          </p>
<p>
            The <span class="command"><strong>aftr</strong></span> daemon will eventually execute
            the shell script file with the <code class="option">stop</code> argument
            before it exits.
          </p>
<p>
            The <code class="filename">conf</code> directory provides examples
            (including the configuration files used in our
            testbeds). <code class="filename">aftr-script.freebsd</code>
            variant is for a FreeBSD based AFTR.
          </p>
</dd>
<dt><span class="term">-u <em class="replaceable"><code>socket-name</code></em></span></dt>
<dd><p>
            As an alternative to TCP over IPv4 and IPv6 with localhost
            control channels, the <span class="command"><strong>aftr</strong></span> process can
            accept PF_UNIX stream socket control channel on the
            <em class="replaceable"><code>socket-name</code></em>.
          </p></dd>
</dl></div>
</div>
<div class="refsect1" title="SEE ALSO">
<a name="id2666207"></a><h2>SEE ALSO</h2>
<p>
    <span class="citerefentry"><span class="refentrytitle">aftr.conf</span>(5)</span>,
    <span class="citerefentry"><span class="refentrytitle">aftr.commands</span>(5)</span>
    </p>
</div>
<div class="refsect1" title="AUTHOR">
<a name="id2666241"></a><h2>AUTHOR</h2>
<p><span class="corpauthor">Internet Systems Consortium</span></p>
</div>
</div>
</div>
<div class="sect1" title="3.3. Configuration File">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2663633"></a>3.3. Configuration File</h2></div></div></div>
<p>
         Included inline <span class="refentrytitle">aftr-conf</span>
         (5)
       </p>
<div class="refentry" title="aftr.conf">
<a name="id2670232"></a><div class="titlepage"></div>
<div class="refnamediv">
<h2>Name</h2>
<p><code class="filename">aftr.conf</code> &#8212; configuration file for aftr</p>
</div>
<div class="refsynopsisdiv" title="Synopsis">
<h2>Synopsis</h2>
<div class="cmdsynopsis"><p><code class="command">aftr.conf</code> </p></div>
</div>
<div class="refsect1" title="DESCRIPTION">
<a name="id2710770"></a><h2>DESCRIPTION</h2>
<p>
      The <span class="command"><strong>aftr</strong></span> daemon requires a configuration file.
      By default it is named <code class="filename">aftr.conf</code>, and is
      located in <code class="varname">$src_path</code>.
      The <code class="varname">AFTRCONFIG</code> environment
      variable and the <code class="option">-c</code> argument give an alternate path.
      Sample configuration files are provided in
      <code class="filename">$src_path/conf/aftr.conf</code> (OS independent).
    </p>
<p>
      The configuration file consists of a set of one-line configuration
      commands.  Commands are not case sensitive.  Any line beginning with '#'
      or whitespace is ignored as a comment.
    </p>
<p>
      Configuration and interactive commands belong to sections:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
          section zero is for global parameters which must be defined before
          anything else when they are not kept to their default values,
          for instance <span class="command"><strong>defmtu</strong></span>.
        </p></li>
<li class="listitem"><p>
          section one is for required parameters, for instance
          <span class="command"><strong>acl6</strong></span>.
        </p></li>
<li class="listitem"><p>
          section two is for reloadable parameters, for instance
          <span class="command"><strong>nat</strong></span>.
        </p></li>
<li class="listitem"><p>
          interactive only commands are in the section three.
        </p></li>
</ul></div>
<p>
    </p>
<p>
      Only the section one commands are required; reasonable defaults are
      provided for all other configuration parameters.  See
      <code class="filename">conf/aftr.conf</code> for an example of a minimal
      configuration file.
    </p>
</div>
<div class="refsect1" title="GLOBAL CONFIGURATION COMMANDS">
<a name="id2705160"></a><h2>GLOBAL CONFIGURATION COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>autotunnel on|off</strong></span></span></dt>
<dd><p>
          Alias of <strong class="userinput"><code>default tunnel auto on|off</code></strong>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>bucket tcp|udp|icmp size <em class="replaceable"><code>size</code></em></strong></span></span></dt>
<dd><p>
          Specifies the bucket size. Compile time options are
          <code class="varname">[TCP|UDP|ICMP]BUCKSZ</code>,
          default values are: <code class="varname">TCPBUCKSZ</code> 10,
          <code class="varname">UDPBUCKSZ</code> 8, <code class="varname">ICMPBUCKSZ</code> 3.
          Minimum is 0 (excluded) and maximum 255.
        </p></dd>
<dt><span class="term"><span class="command"><strong>decay 1|5|15 <em class="replaceable"><code>decay</code></em></strong></span></span></dt>
<dd><p>
          Specifies decay values for 1, 5 and 15 mn rates. Compile time
          options are <code class="varname">DECAY{1,5,15}</code>, default values are:
          <code class="varname">DECAY1</code> exp(-1/60), <code class="varname">DECAY5</code>
          exp(-1/300), <code class="varname">DECAY15</code> exp(-1/900).
          Minimum is 0.0 and maximum 1.0.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default fragment equal on|off</strong></span></span></dt>
<dd><p>
          Enables or disables equalizing the length of IPv6 fragments.
          Default is off.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default fragment lifetime <em class="replaceable"><code>lifetime</code></em></strong></span></span></dt>
<dd><p>
          Specifies the lifetime of fragments in reassembly queues. Compile
          time option is <code class="varname">FRAG_LIFETIME</code>, default value is
          30 seconds.
          Minimum is 0 (excluded) and maximum 1200.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default fragment ipv6|in|out maxcount <em class="replaceable"><code>maxcount</code></em></strong></span></span></dt>
<dd><p>
          Maximum number of entries in reassembly queues ('in' is IPv4 from
          clients to the Internet, 'out' is IPv4 from the Internet to clients).
          Compile time options are <code class="varname">FRAG{6,IN,OUT}_MAXCNT</code>,
          default values are 1024. Minimum is 0 (included so it is possible to
          disable reassembly), maximum is 16535.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default hold lifetime <em class="replaceable"><code>lifetime</code></em></strong></span></span></dt>
<dd><p>
          Specifies the lifetime of expired NAT entries in the hold queue.
          Compile time option is <code class="varname">HOLD_LIFETIME</code>, default
          value is 120 seconds. Minimum is 0 (included), maximum is 600.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default nat lifetime tcp|closed|udp|icmp|retrans <em class="replaceable"><code>lifetime</code></em></strong></span></span></dt>
<dd><p>
          Specifies the lifetime of dynamic NAT entries ('closed' is for closed
          TCP sessions, 'retrans' is used for response not yet received).
          Compile time options are
          <code class="varname">[TCP|CLOSED_TCP|UDP|ICMP|RETRANS]_LIFETIME</code>,
          default values are TCP (600), closed TCP (120, aka 2*MSL), UDP (300),
          ICMP (30), retrans (10). Minimum is 0 (excluded), maximum 36000
          (10 hours).
        </p></dd>
<dt><span class="term"><span class="command"><strong>default pool tcp|udp|echo <em class="replaceable"><code>min</code></em>-<em class="replaceable"><code>max</code></em></strong></span></span></dt>
<dd><p>
          Specifies the default port (or id for icmp echo) ranges for pools.
          Compile time options are <code class="varname">[TCP|UDP]_[MIN|MAX]PORT</code>,
          <code class="varname">ICMP_[MIN|MAX]ID</code>, default values are
          <code class="varname">TCP_MINPORT</code> 2048, <code class="varname">UDP_MINPORT</code>
          512, <code class="varname">ICMP_MINID</code> 0, <code class="varname">TCP_MAXPORT</code>
          65535, <code class="varname">UDP_MAXPORT</code> 65535,
          <code class="varname">ICMP_MAXID</code> 65535.
          Minimum is 1 (0 for ICMP), maximum 63535. 
        </p></dd>
<dt><span class="term"><span class="command"><strong>default private <em class="replaceable"><code>IPv4_prefix</code></em>/<em class="replaceable"><code>prefix_length</code></em></strong></span></span></dt>
<dd><p>
	  Add a private prefix to IPv4 ACLs. The default is RFC 1918 prefixes
	  and the 192.0.0.0/29 from the ds-lite draft.
         </p></dd>
<dt><span class="term"><span class="command"><strong>default tunnel auto on|off</strong></span></span></dt>
<dd><p>
          Enables or disables on-the-fly tunnel creation.  Default is on.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default tunnel mss on|off</strong></span></span></dt>
<dd><p>
          This enables or disables TCP MSS patching on packets going from and
          to tunnels.  Can be overridden by per-tunnel configuration.  If any
          tunnels are explicitly configured, this must be specified before
          them.  Default is off.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default tunnel mtu <em class="replaceable"><code>mtu</code></em></strong></span></span></dt>
<dd><p>
          Specifies <em class="replaceable"><code>mtu</code></em> as the default IPv6 MTU of
          tunnels. Can be overridden by per-tunnel configuration.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default tunnel toobig on|off|strict</strong></span></span></dt>
<dd><p>
          This specifies the policy for packets from the Internet
          which are too big (i.e., they don't fit in one IPv6
          encapsulating packet) and are marked as <span class="quote">&#8220;<span class="quote">don't
          fragment</span>&#8221;</span>. 'On' means a ICMPv4 packet too big error
          is returned to the source, 'off' the packet just go through,
          and 'strict' the packet is dropped with a ICMPv4
          error. Default is on (i.e., the packet is encapsulated into
          some IPv6 fragments and a ICMP error is returned for path
          MTU determination).
        </p></dd>
<dt><span class="term"><span class="command"><strong>default tunnel fragment ipv6|ipv4 maxcount <em class="replaceable"><code>maxcount</code></em></strong></span></span></dt>
<dd><p>
          Specifies the maximum number of reassembly queue entries per tunnel.
          Compile time options are <code class="varname">FRAGTN[46]_MAXCNT</code>,
          default values are  <code class="varname">FRAGTN6_MAXCNT</code> 16,
          <code class="varname">FRAGTN4_MAXCNT</code> 64. Mininum is 0 (included for
          reassembly disable), maximum is 255.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default tunnel nat tcp|udp|icmp maxcount <em class="replaceable"><code>maxcount</code></em></strong></span></span></dt>
<dd><p>
          Specifies the maximum number of NAT entries per tunnel. Compile time
          options are <code class="varname">[TCP|UDP|ICMP]_MAXTNATCNT</code>, default
          values are <code class="varname">TCP_MAXNATCNT</code> 2000,
          <code class="varname">UDP_MAXNATCNT</code> 200,
          <code class="varname">ICMP_MAXNATCNT</code> 50.
          Minimum is 0 (included), maximum is 65535.
        </p></dd>
<dt><span class="term"><span class="command"><strong>default tunnel nat tcp|udp|icmp rate <em class="replaceable"><code>limit</code></em></strong></span></span></dt>
<dd><p>
          Specifies the maximum rate of dynamic NAT creation per second.
          Compile time options are <code class="varname">[TCP|UDP|ICMP]_MAXTNATRT</code>,
          default values are <code class="varname">TCP_MAXNATRT</code> 50,
          <code class="varname">UDP_MAXNATRT</code> 20,
          <code class="varname">ICMP_MAXNATRT</code> 5.
          Minimum is 0 (included), maximum 255.
        </p></dd>
<dt><span class="term"><span class="command"><strong>delete private<em class="replaceable"><code>IPv4_address</code></em></strong></span></span></dt>
<dd><p>
          This removes the IPv4 private prefix with the IPv4 address.
	  It is an error to have no private prefixes.
        </p></dd>
<dt><span class="term"><span class="command"><strong>defmss on|off</strong></span></span></dt>
<dd><p>
          Alias of <strong class="userinput"><code>default tunnel mss on|off</code></strong>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>defmtu <em class="replaceable"><code>mtu</code></em></strong></span></span></dt>
<dd><p>
          Alias of <strong class="userinput"><code>default tunnel mtu
            <em class="replaceable"><code>mtu</code></em></code></strong>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>deftoobig on|off|strict</strong></span></span></dt>
<dd><p>
          Alias of <strong class="userinput"><code>default tunnel toobig on|off|strict</code></strong>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>eqfrag on|off</strong></span></span></dt>
<dd><p>
          Alias of <strong class="userinput"><code>default fragment equal on|off</code></strong>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>quantum <em class="replaceable"><code>quantum</code></em></strong></span></span></dt>
<dd><p>
          Specifies the number of packets dealt with in one main loop round
          (i.e., the size of a slice of work). Compile time option is
          <code class="varname">QUANTUM</code>, default value is 20. Minimum is
          2 (included), maximum is 255.
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="REQUIRED CONFIGURATION COMMANDS">
<a name="id2692271"></a><h2>REQUIRED CONFIGURATION COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>address endpoint <em class="replaceable"><code>IPv6_address</code></em></strong></span></span></dt>
<dd>
<p>
          <em class="replaceable"><code>IPv6_address</code></em> is the AFTR endpoint
          address of the Softwire tunnels.
          If the DHCPv6 ds-lite option is used, this address must match the
          advertised address.
        </p>
<p>
          It is a required command: it  absolutely must be present in the
          <code class="filename">aftr.conf</code> file; the <span class="command"><strong>aftr</strong></span>
          daemon will not start without it.
        </p>
</dd>
<dt><span class="term"><span class="command"><strong>address icmp <em class="replaceable"><code>IPv4_address</code></em></strong></span></span></dt>
<dd><p>
          <em class="replaceable"><code>IPv4_address</code></em> is a global IPv4 address
          used as the source for ICMP errors sent back to the Internet (i.e.,
          the ICMPv4 errors will look like returned from an intermediate
          router that has this address). It is a required command.
        </p></dd>
<dt><span class="term"><span class="command"><strong>pool <em class="replaceable"><code>IPv4_address</code></em> [<span class="optional">tcp|udp|echo <em class="replaceable"><code>min</code></em>-<em class="replaceable"><code>max</code></em></span>]</strong></span></span></dt>
<dd>
<p>
          This specifies a global IPv4 address that will be used as the source
          address of NAT'ed packets sent to the Internet.  Multiple global
          addresses can be specified, at least one is required.
        </p>
<p>
          The optional part limits the port (or id) range used for the protocol
          with the global IPv4 address in dynamical bindings (i.e., not static
          or A+P bindings which can use the reserved ports outside the range).
        </p>
</dd>
<dt><span class="term"><span class="command"><strong>acl6 <em class="replaceable"><code>IPv6_prefix</code></em>/<em class="replaceable"><code>prefix_length</code></em></strong></span></span></dt>
<dd><p>
          This adds an (accept) entry in the IPv6 ACL. Note for a regular
          IPv6 packet the ACL is checked only when no tunnel was found,
          and the default is <span class="quote">&#8220;<span class="quote">deny all</span>&#8221;</span>, so at least one acl6
          entry in the configuration file is required.
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="RELOADABLE CONFIGURATION COMMANDS">
<a name="id2692428"></a><h2>RELOADABLE CONFIGURATION COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>tunnel <em class="replaceable"><code>IPv6_remote</code></em> [<span class="optional"><em class="replaceable"><code>IPv4_src</code></em></span>]</strong></span></span></dt>
<dd><p>
          This specifies an IPv4-in-IPv6 tunnel configuration.
          <em class="replaceable"><code>IPv6_remote</code></em> is the remote (ds-lite
          client) IPv6 address of the tunnel. Either the tunnel is associated
          with a source address in a round robin way or it is associated to
          the specified <em class="replaceable"><code>IPv4_src</code></em>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>nat <em class="replaceable"><code>IPv6_remote</code></em> tcp|udp <em class="replaceable"><code>IPv4_src</code></em> <em class="replaceable"><code>port_src</code></em> <em class="replaceable"><code>IPv4_new</code></em> <em class="replaceable"><code>port_new</code></em></strong></span></span></dt>
<dd><p>
          This defines a static binding/NAT entry for the client
          behind the tunnel at <em class="replaceable"><code>IPv6_remote</code></em>.
          <em class="replaceable"><code>*_src</code></em> are the source IPv4 address
          and port at the tunnel side of the NAT,
          <em class="replaceable"><code>*_new</code></em> are the source IPv4 address
          and port at the Internet side of the NAT.
          <em class="replaceable"><code>IPv4_new</code></em> should be a reserved source
          NAT address, <em class="replaceable"><code>port_new</code></em> must not be inside
          a dynamic port range.
        </p></dd>
<dt><span class="term"><span class="command"><strong>prr <em class="replaceable"><code>IPv6_remote</code></em> tcp|udp <em class="replaceable"><code>IPv4</code></em> <em class="replaceable"><code>port</code></em></strong></span></span></dt>
<dd><p>
          This defines a Port-Range Router/A+P null NAT entry for the
          client behind the tunnel at <em class="replaceable"><code>IPv6_remote</code></em>.
          <em class="replaceable"><code>IPv4</code></em> and <em class="replaceable"><code>port</code></em>
          are the source IPv4 address and  port at the tunnel side of the NAT.
          They stay unchanged both ways: this entry is used to check
          authorization and perform port routing.
        </p></dd>
<dt><span class="term"><span class="command"><strong>nonat <em class="replaceable"><code>IPv6_remote</code></em> <em class="replaceable"><code>IPv4</code></em>/<em class="replaceable"><code>prefix_length</code></em></strong></span></span></dt>
<dd><p>
          This defines a No-NAT tunnel for the client behind the tunnel at
          <em class="replaceable"><code>IPv6_remote</code></em> and the prefix
          <em class="replaceable"><code>IPv4</code></em>/<em class="replaceable"><code>prefix_length</code></em>.
          No translation is performed for matching packets.
        </p></dd>
<dt><span class="term"><span class="command"><strong>mss <em class="replaceable"><code>IPv6_remote</code></em> on|off</strong></span></span></dt>
<dd><p>
          This enables or disables TCP MSS patching on packets going
          from and to the tunnel of <em class="replaceable"><code>IPv6_remote</code></em>.
          Default is off.
        </p></dd>
<dt><span class="term"><span class="command"><strong>mtu <em class="replaceable"><code>IPv6_remote</code></em> <em class="replaceable"><code>mtu</code></em></strong></span></span></dt>
<dd><p>
          This changes the IPv6 MTU of the tunnel of
          <em class="replaceable"><code>IPv6_remote</code></em> to
          <em class="replaceable"><code>mtu</code></em>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>toobig <em class="replaceable"><code>IPv6_remote</code></em> on|off|strict</strong></span></span></dt>
<dd><p>
          Per-tunnel configuration of the too big policy.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug set [<span class="optional"><em class="replaceable"><code>level</code></em></span>]</strong></span></span></dt>
<dd><p>
          Specifies the debug level.  Default is 0.  If set to non 0,
          verbose log messages will be dumped to stderr.  The higher the level
          is, the noiser the logs are.  At present, the meaningful levels are
          1 (log tunnel creation), 3 (log packet reads and writes), and 10
          (function entry tracing).  If the level is omitted, it is set to 1.
        </p></dd>
<dt><span class="term"><span class="command"><strong>try tunnel <em class="replaceable"><code>IPv6_remote</code></em> [<span class="optional"><em class="replaceable"><code>IPv4_src</code></em></span>]</strong></span></span></dt>
<dd><p>
	  Create when it doesn't already exist an IPv4-in-IPv6 tunnel,
          returns in all cases the description of the tunnel entry. This
          command should be used by tools managing temporary port forwarding.
	  <em class="replaceable"><code>IPv6_remote</code></em> must be acceptable for IPv6
	  ACLs.
        </p></dd>
<dt><span class="term"><span class="command"><strong>try nat <em class="replaceable"><code>IPv6_remote</code></em> tcp|udp <em class="replaceable"><code>IPv4_src</code></em> <em class="replaceable"><code>port_src</code></em> <em class="replaceable"><code>IPv4_new</code></em> <em class="replaceable"><code>port_new</code></em></strong></span></span></dt>
<dd><p>
          Create when it doesn't already exist a static binding/NAT
          entry. This command should be used by tools managing
          temporary port forwarding. The tunnel must exist.
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="SEE ALSO">
<a name="id2692806"></a><h2>SEE ALSO</h2>
<p>
    <span class="citerefentry"><span class="refentrytitle">aftr</span>(8)</span>,
    <span class="citerefentry"><span class="refentrytitle">aftr.commands</span>(5)</span>
    </p>
</div>
<div class="refsect1" title="AUTHOR">
<a name="id2692840"></a><h2>AUTHOR</h2>
<p><span class="corpauthor">Internet Systems Consortium</span></p>
</div>
</div>
</div>
<div class="sect1" title="3.4. Interactive Commands">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2663655"></a>3.4. Interactive Commands</h2></div></div></div>
<p>
         Included inline <span class="refentrytitle">aftr-commands</span>
         (5)
       </p>
<div class="refentry" title="aftr.commands">
<a name="id2678978"></a><div class="titlepage"></div>
<div class="refnamediv">
<h2>Name</h2>
<p><code class="filename">aftr.command</code> &#8212; interactive commands for aftr</p>
</div>
<div class="refsynopsisdiv" title="Synopsis">
<h2>Synopsis</h2>
<div class="cmdsynopsis"><p><code class="command">aftr.commands</code> </p></div>
</div>
<div class="refsect1" title="DESCRIPTION">
<a name="id2716880"></a><h2>DESCRIPTION</h2>
<p>
      The <span class="command"><strong>aftr</strong></span> daemon runs in the background.
      After it starts, it can be controlled interactively from a
      control channel (aka. a session).
    </p>
<p>
      All of the reloadable configuration commands can be allowed to run
      from the command line, to add or change configuration.
      In addition, the following commands can be run interactively.
    </p>
</div>
<div class="refsect1" title="INTERACTIVE COMMANDS">
<a name="id2685514"></a><h2>INTERACTIVE COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>abort</strong></span></span></dt>
<dd><p>
          Call <span class="refentrytitle">abort</span>(3)
          to create a core file. Please try to use it only on forked processes.
        </p></dd>
<dt><span class="term"><span class="command"><strong>echo <em class="replaceable"><code>xxx</code></em></strong></span></span></dt>
<dd><p>
	  Echo the command. This can be used for an external tool to
	  synchronize with the AFTR daemon.
        </p></dd>
<dt><span class="term"><span class="command"><strong>fork</strong></span></span></dt>
<dd>
<p>
          Fork the <span class="command"><strong>aftr</strong></span> process. In the parent the current
          session is closed (so after this command you'll talk only to the
          child) and other activities, including packet forwarding, are
          continued. In the child all file descriptors at the exception of the
          current session are closed.
        </p>
<p>
          This command should be used before to execution an expensive
          and atomic operation like list commands or some debug
          commands, and of course the abort command.
        </p>
</dd>
<dt><span class="term"><span class="command"><strong>help [<span class="optional">all</span>]</strong></span></span></dt>
<dd><p>
          List available or all commands.
        </p></dd>
<dt><span class="term"><span class="command"><strong>kill</strong></span></span></dt>
<dd><p>
          Orderly kill the <span class="command"><strong>aftr</strong></span> process.
        </p></dd>
<dt><span class="term"><span class="command"><strong>load <em class="replaceable"><code>file</code></em></strong></span></span></dt>
<dd><p>
          Redirect the input of the current session from the content
          of the file.  This is done in an atomic way (i.e., there is
          no other activity during the operation) but exists if a
          command fails.
        </p></dd>
<dt><span class="term"><span class="command"><strong>quit</strong></span></span></dt>
<dd><p>
          Obsolete, use <span class="command"><strong>session close</strong></span> (for closing
          the current session) or <span class="command"><strong>kill</strong></span> (for killing
          the process).
        </p></dd>
<dt><span class="term"><span class="command"><strong>reboot</strong></span></span></dt>
<dd><p>
          Reboot the whole process.
        </p></dd>
<dt><span class="term"><span class="command"><strong>reload</strong></span></span></dt>
<dd>
<p>
          Reload the section two part of the config file. This is sliced with
          the packet forwarding, but not with session reading (so you can't
          execute a command until reload is finished).
        </p>
<p>
          The reload process uses a generation system: static NAT,
          PRR/A+P and no-NAT entries in the reloaded file are put in
          the next generation.  If the reload succeeds, global entries
          in older generations are garbaged collected, if it fails new
          generation entries are backtracked to the previous
          generation. Garbage collection and backtracking are sliced
          with the packet forwarding, another reload command is
          forbidden until they finish so a reload flushes the input
          buffer of the current session.
        </p>
</dd>
<dt><span class="term"><span class="command"><strong>show dropped|stat</strong></span></span></dt>
<dd><p>
          Aliases of <span class="command"><strong>debug dropped</strong></span> and
          <span class="command"><strong>debug stat</strong></span>, display dropped packet and
          general statistics.
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="DEBUG COMMANDS">
<a name="id2662140"></a><h2>DEBUG COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>noop</strong></span></span></dt>
<dd><p>
          Returns <code class="computeroutput">LOG: alive</code>.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug check [<span class="optional">nat|nonat|pool|session|tunnel</span>]</strong></span></span></dt>
<dd><p>
          Performs some sanity checks on structures. Reserved to
          expert usage on a forked process (or better core file
          debugged with gdb). Note it uses recusive deep structure
          walking so can eat a lot of stack.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug disable [<span class="optional">clear</span>]</strong></span></span></dt>
<dd><p>
          Disable per-tunnel debug counters. Optionally clear them.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug dropped</strong></span></span></dt>
<dd><p>
          This displays the dropped packet statistics with reasons.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug enable <em class="replaceable"><code>addr</code></em></strong></span></span></dt>
<dd><p>
          Enable per-tunnel debug counters for the tunnel with
          <em class="replaceable"><code>addr</code></em> remote IPv6 address.
          Note the counters can be incremented only when the
          involved tunnel is known, for instance, only after reassembly.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug fragment IPv6|in|out</strong></span></span></dt>
<dd><p>
          This displays the list of IPv4 or IPv6 fragments awaiting reassembly.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug fragment <em class="replaceable"><code>addr</code></em></strong></span></span></dt>
<dd><p>
          This displays information about a single fragment or
          fragment chain.
          <em class="replaceable"><code>add</code></em>&gt; is the memory address of the
          fragment structure (from a previous <span class="command"><strong>debug
          fragment</strong></span> command).
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug hash</strong></span></span></dt>
<dd><p>
          This displays some statistics about the various hash tables
          (fragment, nat, and tunnel).
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug nat</strong></span></span></dt>
<dd><p>
          This displays some information about the nat hash table and
          entry table.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug nat <em class="replaceable"><code>addr</code></em></strong></span></span></dt>
<dd><p>
          This displays detailed information about a single nat binding.
          <em class="replaceable"><code>addr</code></em> is the memory address of the nat
          structure (from a previous <span class="command"><strong>debug nat</strong></span> command).
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug nonat</strong></span></span></dt>
<dd><p>
          This displays the list of no-nat tunnel entries.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug pool</strong></span></span></dt>
<dd><p>
          This displays the global IPv4 addresses that will be used
          for NAT mapping.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug session</strong></span></span></dt>
<dd><p>
          This displays the control channel session types with the
          number of active sessions.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug stat</strong></span></span></dt>
<dd><p>
          This displays some general statistics about packets in and out.
          If per-tunnel debug counters are enable, displays them.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug tunnel</strong></span></span></dt>
<dd><p>
          This displays some information about the tunnel table.
        </p></dd>
<dt><span class="term"><span class="command"><strong>debug tunnel <em class="replaceable"><code>IPv6_remote</code></em></strong></span></span></dt>
<dd><p>
          This displays some information about a single tunnel.
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="DELETE COMMANDS">
<a name="id2683426"></a><h2>DELETE COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>delete acl6 <em class="replaceable"><code>IPv6_address</code></em></strong></span></span></dt>
<dd><p>
          This removes the IPv6 ACL entry with the IPv6 address.
        </p></dd>
<dt><span class="term"><span class="command"><strong>delete nat <em class="replaceable"><code>IPv6_remote</code></em> tcp|udp <em class="replaceable"><code>IPv4</code></em> <em class="replaceable"><code>port</code></em></strong></span></span></dt>
<dd><p>
          This removes a static or dynamic NAT binding.
        </p></dd>
<dt><span class="term"><span class="command"><strong>delete nonat <em class="replaceable"><code>IPv6_remote</code></em></strong></span></span></dt>
<dd><p>
          This removes a no-nat tunnel entry.
        </p></dd>
<dt><span class="term"><span class="command"><strong>delete private <em class="replaceable"><code>IPv4_address</code></em></strong></span></span></dt>
<dd><p>
          Look at zone zero configuration commands.
        </p></dd>
<dt><span class="term"><span class="command"><strong>delete prr <em class="replaceable"><code>IPv6_remote</code></em> tcp|udp <em class="replaceable"><code>IPv4</code></em> <em class="replaceable"><code>port</code></em></strong></span></span></dt>
<dd><p>
          This removes a Port-Range Router/A+P null NAT binding.
        </p></dd>
<dt><span class="term"><span class="command"><strong>delete tunnel <em class="replaceable"><code>IPv6_remote</code></em></strong></span></span></dt>
<dd><p>
          This removes a tunnel and all NAT bindings associated with it.
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="LIST COMMANDS">
<a name="id2683580"></a><h2>LIST COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>list acl6</strong></span></span></dt>
<dd><p>
          List IPv6 ACLs.
        </p></dd>
<dt><span class="term"><span class="command"><strong>list default</strong></span></span></dt>
<dd><p>
          List all the default values which can be set by a
          'default'/'global' command.
        </p></dd>
<dt><span class="term"><span class="command"><strong>list nat [<span class="optional">conf|static|prr|dynamic|all|global</span>]</strong></span></span></dt>
<dd><p>
          List the NAT entries in the configuration file
          format. Default is to list only the configured ('conf') NAT
          entries. 'global' lists the the configured global (i.e., not
          by a session) active (i.e., not to be garbaged collected after
          a reload) NAT entries.
        </p></dd>
<dt><span class="term"><span class="command"><strong>list nonat</strong></span></span></dt>
<dd><p>
          List all the No-NAT tunnel entries in the configuration file format.
        </p></dd>
<dt><span class="term"><span class="command"><strong>list pool</strong></span></span></dt>
<dd><p>
          List the NATted source addresses with current port ranges in the
          configuration file format.
        </p></dd>
<dt><span class="term"><span class="command"><strong>list session [<span class="optional"><em class="replaceable"><code>name</code></em>|<em class="replaceable"><code>generation</code></em></span>]</strong></span></span></dt>
<dd><p>
          List the static NAT, PRR/A+P and no-NAT entries created by
          the current session or the session
          with <em class="replaceable"><code>name</code></em> or
          with <em class="replaceable"><code>generation</code></em> (note these
          entries will be flushed when the session will be closed so
          this command can be used to get them in order to include
          them in the config).
        </p></dd>
<dt><span class="term"><span class="command"><strong>list tunnel</strong></span></span></dt>
<dd><p>
          List the tunnel entries in the configuration file format,
          including specific MTU (if different from the default MTU).
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="SESSION COMMANDS">
<a name="id2683752"></a><h2>SESSION COMMANDS</h2>
<p>
      These commands deal directly with sessions (aka. control channels).
    </p>
<div class="variablelist"><dl>
<dt><span class="term"><span class="command"><strong>session close [<span class="optional"><em class="replaceable"><code>name</code></em>|<em class="replaceable"><code>generation</code></em></span>]</strong></span></span></dt>
<dd><p>
          Close the current or designed session. Delete all the static NAT,
          PRR/A+P and no-NAT entries created by the current session and which
          were not promoted to global/permanent entries by a reload.
        </p></dd>
<dt><span class="term"><span class="command"><strong>session config on|off</strong></span></span></dt>
<dd><p>
          Enable/disable the section two configuration commands. By default
          configuration commands must go to the config file.
        </p></dd>
<dt><span class="term"><span class="command"><strong>session log on|off</strong></span></span></dt>
<dd><p>
          Log errors or don't for the current session. Default is on.
        </p></dd>
<dt><span class="term"><span class="command"><strong>session name [<span class="optional"><em class="replaceable"><code>name</code></em></span>]</strong></span></span></dt>
<dd><p>
          Display or set the name of the current session. The stdio
          initial session is statically named 'tty'.
        </p></dd>
<dt><span class="term"><span class="command"><strong>session notify on|off</strong></span></span></dt>
<dd><p>
	  Log tunnel removal or don't to the current session. Default is off.
        </p></dd>
</dl></div>
</div>
<div class="refsect1" title="SEE ALSO">
<a name="id2718023"></a><h2>SEE ALSO</h2>
<p>
    <span class="citerefentry"><span class="refentrytitle">aftr</span>(8)</span>,
    <span class="citerefentry"><span class="refentrytitle">aftr.conf</span>(5)</span>
    </p>
</div>
<div class="refsect1" title="AUTHOR">
<a name="id2718052"></a><h2>AUTHOR</h2>
<p><span class="corpauthor">Internet Systems Consortium</span></p>
</div>
</div>
</div>
<div class="sect1" title="3.5. Command Summary">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2663677"></a>3.5. Command Summary</h2></div></div></div>
<p>
       </p>
<div class="table">
<a name="id2663685"></a><p class="title"><b>Table 3.1. </b></p>
<div class="table-contents"><table border="1">
<colgroup>
<col align="left">
<col align="center">
<col align="left">
</colgroup>
<thead><tr>
<th align="left">Name</th>
<th align="center">Section</th>
<th align="left">Syntax</th>
</tr></thead>
<tfoot></tfoot>
<tbody>
<tr>
<td align="left">abort</td>
<td align="center">interactive</td>
<td align="left"> </td>
</tr>
<tr>
<td align="left">acl6</td>
<td align="center">one or two</td>
<td align="left">
             <em class="replaceable"><code>IPv6</code></em>/<em class="replaceable"><code>prefix_length</code></em>
           </td>
</tr>
<tr>
<td align="left">address</td>
<td align="center">one</td>
<td align="left">endpoint <em class="replaceable"><code>IPv6</code></em>|icmp <em class="replaceable"><code>IPv4</code></em>
           </td>
</tr>
<tr>
<td align="left">autotunnel</td>
<td align="center">zero</td>
<td align="left">on|off</td>
</tr>
<tr>
<td align="left">bucket</td>
<td align="center">zero</td>
<td align="left">tcp|udp|icmp size <em class="replaceable"><code>size</code></em>
</td>
</tr>
<tr>
<td align="left">debug</td>
<td align="center">&gt;= two</td>
<td align="left">set|enable|...|tunnel</td>
</tr>
<tr>
<td align="left">decay</td>
<td align="center">zero</td>
<td align="left">1|5|15 <em class="replaceable"><code>decay</code></em>
</td>
</tr>
<tr>
<td align="left">default</td>
<td align="center">zero</td>
<td align="left">fragment|hold|...|tunnel</td>
</tr>
<tr>
<td align="left">defmss</td>
<td align="center">zero</td>
<td align="left">on|off</td>
</tr>
<tr>
<td align="left">defmtu</td>
<td align="center">zero</td>
<td align="left"><em class="replaceable"><code>mtu</code></em></td>
</tr>
<tr>
<td align="left">deftoobig</td>
<td align="center">zero</td>
<td align="left">on|off|strict</td>
</tr>
<tr>
<td align="left">delete</td>
<td align="center">== add</td>
<td align="left">acl6|nat|nonat|private|prr|tunnel</td>
</tr>
<tr>
<td align="left">echo</td>
<td align="center">interactive</td>
<td align="left"><em class="replaceable"><code>xxx</code></em></td>
</tr>
<tr>
<td align="left">eqfrag</td>
<td align="center">zero</td>
<td align="left">on|off</td>
</tr>
<tr>
<td align="left">fork</td>
<td align="center">interactive</td>
<td align="left"> </td>
</tr>
<tr>
<td align="left">help</td>
<td align="center">interactive</td>
<td align="left">[<span class="optional">all</span>]</td>
</tr>
<tr>
<td align="left">kill</td>
<td align="center">interactive</td>
<td align="left"> </td>
</tr>
<tr>
<td align="left">list</td>
<td align="center">interactive</td>
<td align="left">nat|nonat|pool|tunnel</td>
</tr>
<tr>
<td align="left">load</td>
<td align="center">interactive</td>
<td align="left"><em class="replaceable"><code>file</code></em></td>
</tr>
<tr>
<td align="left">mss</td>
<td align="center">&gt;= two</td>
<td align="left">
<em class="replaceable"><code>IPv6</code></em> on|off</td>
</tr>
<tr>
<td align="left">mtu</td>
<td align="center">&gt;= two</td>
<td align="left">
<em class="replaceable"><code>IPv6</code></em> <em class="replaceable"><code>mtu</code></em>
</td>
</tr>
<tr>
<td align="left">nat</td>
<td align="center">two</td>
<td align="left">
<em class="replaceable"><code>IPv6</code></em> tcp|udp <em class="replaceable"><code>IPv4_src</code></em> ...</td>
</tr>
<tr>
<td align="left">nonat</td>
<td align="center">two</td>
<td align="left">
<em class="replaceable"><code>IPv6</code></em> <em class="replaceable"><code>IPv4</code></em>/<em class="replaceable"><code>prefix_length</code></em>
</td>
</tr>
<tr>
<td align="left">noop</td>
<td align="center">interactive</td>
<td align="left"> </td>
</tr>
<tr>
<td align="left">pool</td>
<td align="center">one</td>
<td align="left">
<em class="replaceable"><code>IPv4</code></em> [tcp|udp|echo <em class="replaceable"><code>min</code></em>-<em class="replaceable"><code>max</code></em>]</td>
</tr>
<tr>
<td align="left">private</td>
<td align="center">zero</td>
<td align="left">
             <em class="replaceable"><code>IPv4</code></em>/<em class="replaceable"><code>prefix_length</code></em>
           </td>
</tr>
<tr>
<td align="left">prr</td>
<td align="center">two</td>
<td align="left">
<em class="replaceable"><code>IPv6</code></em> tcp|udp <em class="replaceable"><code>IPv4</code></em> <em class="replaceable"><code>port</code></em>
</td>
</tr>
<tr>
<td align="left">quantum</td>
<td align="center">zero</td>
<td align="left"><em class="replaceable"><code>quantum</code></em></td>
</tr>
<tr>
<td align="left">reboot</td>
<td align="center">interactive</td>
<td align="left"> </td>
</tr>
<tr>
<td align="left">reload</td>
<td align="center">interactive</td>
<td align="left"> </td>
</tr>
<tr>
<td align="left">session</td>
<td align="center">interactive</td>
<td align="left">close|config|log|name|notify</td>
</tr>
<tr>
<td align="left">show</td>
<td align="center">interactive</td>
<td align="left">dropped|stat</td>
</tr>
<tr>
<td align="left">toobig</td>
<td align="center">&gt;= two</td>
<td align="left">
<em class="replaceable"><code>IPv6</code></em> on|off|strict</td>
</tr>
<tr>
<td align="left">try</td>
<td align="center">two</td>
<td align="left">tunnel ... | nat <em class="replaceable"><code>IPv6</code></em> tcp|udp <em class="replaceable"><code>IPv4_src</code></em> ...</td>
</tr>
<tr>
<td align="left">tunnel</td>
<td align="center">two</td>
<td align="left">
<em class="replaceable"><code>IPv6</code></em> [<em class="replaceable"><code>IPv4</code></em>]</td>
</tr>
</tbody>
</table></div>
</div>
<p><br class="table-break">
       </p>
</div>
</div>
<div class="chapter" title="Chapter 4. Managing AFTR">
<div class="titlepage"><div><div><h2 class="title">
<a name="id2664294"></a>Chapter 4. Managing AFTR</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="#id2664300">4.1. Syslog</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="#id2664407">4.1.1. Trace Logging</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="#id2664533">4.2. Security</a></span></dt>
<dt><span class="sect1"><a href="#id2664579">4.3. Debug primer</a></span></dt>
</dl>
</div>
<div class="sect1" title="4.1. Syslog">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664300"></a>4.1. Syslog</h2></div></div></div>
<p>
        Errors, debug messages, traces, etc, are logged through syslog
        with <span class="symbol">aftr</span> as the program name.
      </p>
<p>
        The default facility is <code class="constant">LOG_LOCAL5</code> (can be
        changed at compile time by  setting <code class="varname">AFTRFACILITY</code>),
        the default <code class="function">openlog()</code> option is
        <code class="constant">LOG_NDELAY</code> (can be changed at compile time by
        setting <code class="varname">AFTRLOGOPTION</code>, for instance to add 
        <code class="constant">LOG_PID</code>). Levels are:
        </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>critical errors (i.e., the process must be rebooted)
              to <code class="constant">LOG_CRIT</code></p></li>
<li class="listitem"><p>error conditions (i.e., bad packets, not critical
              memory allocation failures, bad commands, etc) to
              <code class="constant">LOG_ERR</code></p></li>
<li class="listitem"><p>warnings to <code class="constant">LOG_WARNING</code></p></li>
<li class="listitem"><p>informational messages (including I/O logs) to
              <code class="constant">LOG_INFO</code></p></li>
<li class="listitem"><p>debug messages (cf. debug set xxx) to
              <code class="constant">LOG_DEBUG</code></p></li>
<li class="listitem"><p>trace messages (see next section) to
              <code class="constant">LOG_NOTICE</code></p></li>
</ul></div>
<p>
      </p>
<div class="sect2" title="4.1.1. Trace Logging">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2664407"></a>4.1.1. Trace Logging</h3></div></div></div>
<p>
          Trace messages are:
          </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
                tunnel add|del <em class="replaceable"><code>client_IPv6</code></em>
              </p></li>
<li class="listitem"><p>
                <em class="replaceable"><code>seconds</code></em> bucket
                <em class="replaceable"><code>client_IPv6</code></em>
                <em class="replaceable"><code>natted_IPv4</code></em> tcp|udp
                [<span class="optional">#<em class="replaceable"><code>port</code></em></span>]+
              </p></li>
</ul></div>
<p>
        </p>
<p>
          If TRACE_NAT was defined at compile time (default is undefined):
        </p>
<p>
          if NOPRIVACY is kept undefined:
          </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
                <em class="replaceable"><code>seconds</code></em> nat add|del
                <em class="replaceable"><code>client_IPv6</code></em> tcp|udp
                <em class="replaceable"><code>natted_IPv4</code></em>
                <em class="replaceable"><code>port</code></em>
              </p></li></ul></div>
<p>
        </p>
<p>
          if NOPRIVACY is defined:
          </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
                <em class="replaceable"><code>seconds</code></em> nat add|del
                <em class="replaceable"><code>client_IPv6</code></em> tcp|udp
                <em class="replaceable"><code>client_IPv4</code></em>
                <em class="replaceable"><code>client_port</code></em>
                <em class="replaceable"><code>natted_IPv4</code></em>
                <em class="replaceable"><code>natted_port</code></em>
                <em class="replaceable"><code>destination_IPv4</code></em>
                <em class="replaceable"><code>destination_port</code></em>
              </p></li></ul></div>
<p>
        </p>
</div>
</div>
<div class="sect1" title="4.2. Security">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664533"></a>4.2. Security</h2></div></div></div>
<p>
       The <span class="command"><strong>aftr</strong></span> process needs the root privilege to
       open the tunnel interface/device.  The TCP over IPv4/IPv6
       control channels are bound to localhost so are limited to the
       local node. There are many tools which provide a secure
       connection forwarding, for instance <span class="command"><strong>ssh -L</strong></span>.
       The PF_UNIX control channel relies on standard file system
       permissions (cf. <span class="command"><strong>umask</strong></span>), it should be used
       for finer control than node access.
       </p>
<p>
       The source address of encapsulated IPv4 in IPv6 packets must be
       a private address. The list of IPv4 private prefixes is
       initialized to RFC 1918 prefixes and the unpublished I-D, it is
       manageable by zone zero commands. IPv6 ACLs filter incoming
       IPv6 packets.
       </p>
<p>
       The <span class="command"><strong>try</strong></span> commands are protected against not
       authorized tunnel creation, i.e., both IPv6 and IPv4 ACLs are
       applied to try command arguments.
       </p>
</div>
<div class="sect1" title="4.3. Debug primer">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664579"></a>4.3. Debug primer</h2></div></div></div>
<p>
       Unlimit the core dump size if you'd like to get core file on
       crashes or with the abort command. On Linux twist the core
       naming to something better than <code class="filename">core</code>
       (cf. <span class="refentrytitle">core</span>(5)).
       Please keep the binary associated to core files. As
       the <span class="command"><strong>fork</strong></span> command is fun but eats memory put
       enough memory in the aftr box...
       </p>
<p>
         When the <span class="command"><strong>aftr</strong></span> process is not (yet) crashed
         but seems no longer to forward packets:
         </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>go to an open session (try to keep on in case the
             alternative fails) or if none open a new one</p></li>
<li class="listitem"><p>check if it is responsive using the <span class="command"><strong>noop</strong></span>
             (answer <code class="computeroutput">LOG: alive</code>), if not
             try to get a core file (attach in gdb and use
             <span class="command"><strong>gcore</strong></span>), kill it
             (another way to get a core file with <span class="command"><strong>^\</strong></span> /
             <span class="command"><strong>kill</strong></span>)
             and relaunch it</p></li>
<li class="listitem"><p>if not in a hurry try to understand the issue with
             <span class="command"><strong>show stat</strong></span> and <span class="command"><strong>show dropped</strong></span>
             </p></li>
<li class="listitem"><p>open a second session, send <span class="command"><strong>fork</strong></span> to get
             a child process where you can use extensive debug, including gdb,
             on it. If you don't know or you can't understand,
             <span class="command"><strong>abort</strong></span> the child process to get a core file.
             </p></li>
<li class="listitem"><p>update the config file if needed, reboot the parent/main
             process (it will lose all the state and restart from the
             beginning)</p></li>
</ul></div>
<p>
        </p>
<p>
          Summary for the busy operator:
          </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><span class="command"><strong>noop</strong></span> -&gt; nothing: go to the
            shell to kill and relaunch it
            </p></li>
<li class="listitem"><p><span class="command"><strong>noop</strong></span> -&gt; expected message: open
              another session, send <span class="command"><strong>fork</strong></span>, wait for
              the child pid message, send <span class="command"><strong>abort</strong></span> on
              this new session. On the previous session (where you
              sent
              <span class="command"><strong>noop</strong></span>), send <span class="command"><strong>reboot</strong></span>
            </p></li>
</ul></div>
<p>
       </p>
</div>
</div>
<div class="chapter" title="Chapter 5. XML Interface">
<div class="titlepage"><div><div><h2 class="title">
<a name="id2664747"></a>Chapter 5. XML Interface</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="#id2664778">5.1. Transport</a></span></dt>
<dt><span class="sect1"><a href="#id2664808">5.2. Remote Configuration Daemon</a></span></dt>
<dt><span class="sect1"><a href="#id2664830">5.3. Remote Configuration Client</a></span></dt>
</dl>
</div>
<p>
      The "XML interface" is a way for service providers to
      programmatically manage static port mappings on behalf of
      their customers.
    </p>
<p>
      For instance, the service provider might have a web portal,
      tied into the provisioning system, through which a customer
      could request a small number of static port mappings.  The
      provisioning system would send an XML-encoded request to the
      AFTR that is serving that customer, and the AFTR would send
      back an XML-encoded reply.
    </p>
<p>
      The <code class="filename">xml</code> subdirectory contains a
      specification for the remote configuration protocol, together
      with a server that runs on the AFTR box, and an example client
      that runs on the provisioning system.
    </p>
<div class="sect1" title="5.1. Transport">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664778"></a>5.1. Transport</h2></div></div></div>
<p>
        The server and client communicate over either HTTP or a
        plain TCP socket.  By default, they use HTTP.  To change to
        TCP socket, you must edit both <code class="filename">xmlconf.py</code> and
        <code class="filename">xmlclient.py</code>, commenting out the
        line <strong class="userinput"><code>TRANSPORT = 'http'</code></strong>, and
        uncommenting the line <strong class="userinput"><code>TRANSPORT = 'socket'</code></strong>.
      </p>
</div>
<div class="sect1" title="5.2. Remote Configuration Daemon">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664808"></a>5.2. Remote Configuration Daemon</h2></div></div></div>
<p>
        Included inline <span class="refentrytitle">xmlconf</span>
        (8)
      </p>
<div class="refentry" title="xmlconf.py">
<a name="id2697667"></a><div class="titlepage"></div>
<div class="refnamediv">
<h2>Name</h2>
<p><span class="application">xmlconf.py</span> &#8212; remote configuration daemon for aftr</p>
</div>
<div class="refsynopsisdiv" title="Synopsis">
<h2>Synopsis</h2>
<div class="cmdsynopsis"><p><code class="command">xmlconf.py</code>  [<code class="option">-l <em class="replaceable"><code>listening-addr</code></em></code>] [<code class="option">-p <em class="replaceable"><code>listening-port</code></em></code>] [<code class="option">-r <em class="replaceable"><code>remote-addr</code></em></code>] [<code class="option">-c <em class="replaceable"><code>config-file</code></em></code>] [<code class="option">-v</code>]</p></div>
</div>
<div class="refsect1" title="OPTIONS">
<a name="id2714231"></a><h2>OPTIONS</h2>
<div class="variablelist"><dl>
<dt><span class="term">-l <em class="replaceable"><code>listening-addr</code></em></span></dt>
<dd><p>
	    This specifies a local address on which to listen.  If not
	    specified, it listens on all local addresses.
          </p></dd>
<dt><span class="term">-p <em class="replaceable"><code>listening-port</code></em></span></dt>
<dd><p>
	    This specifies a local port on which to listen.  Defaults
	    to port 4148 for HTTP transport, or port 4146 for socket
	    transport.
          </p></dd>
<dt><span class="term">-r <em class="replaceable"><code>remote-addr</code></em></span></dt>
<dd><p>
	    This specifies a single address that the server will
	    listen to.  The server should only get configuration
	    requests from the provisioning system, at a known address,
	    so this is a simple form of access control.  Use of this
	    option is not required, but it is recommended.
          </p></dd>
<dt><span class="term">-c <em class="replaceable"><code>config-file</code></em></span></dt>
<dd><p>
	    This specifies the name and location of
	    the <span class="command"><strong>aftr</strong></span> configuration file.  For
	    obvious reasons, this option MUST specify the same file
	    that is used to configure the running
	    <span class="command"><strong>aftr</strong></span> daemon.  Default is
	    <code class="filename">./aftr.conf</code>.
          </p></dd>
<dt><span class="term">-v</span></dt>
<dd><p>
	    This enables run-time debugging messages.  It should not
	    be used in production, but it can help to debug or monitor
	    interactions between <span class="command"><strong>xmlconf.py</strong></span> and
	    the <span class="command"><strong>aftr</strong></span> daemon.
          </p></dd>
</dl></div>
</div>
<div class="refsect1" title="SEE ALSO">
<a name="id2686753"></a><h2>SEE ALSO</h2>
<p>
    <span class="citerefentry"><span class="refentrytitle">aftr</span>(8)</span>,
    <span class="citerefentry"><span class="refentrytitle">aftr.conf</span>(5)</span>,
    <span class="citerefentry"><span class="refentrytitle">xmlclient</span>(8)</span>
    </p>
</div>
<div class="refsect1" title="AUTHOR">
<a name="id2692862"></a><h2>AUTHOR</h2>
<p><span class="corpauthor">Internet Systems Consortium</span></p>
</div>
</div>
</div>
<div class="sect1" title="5.3. Remote Configuration Client">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664830"></a>5.3. Remote Configuration Client</h2></div></div></div>
<p>
        Included inline <span class="refentrytitle">xmlclient</span>
        (8)
      </p>
<div class="refentry" title="xmlclient.py">
<a name="id2702529"></a><div class="titlepage"></div>
<div class="refnamediv">
<h2>Name</h2>
<p><span class="application">xmlclient.py</span> &#8212; remote configuration client for aftr</p>
</div>
<div class="refsynopsisdiv" title="Synopsis">
<h2>Synopsis</h2>
<div class="cmdsynopsis"><p><code class="command">xmlclient.py</code>   <em class="replaceable"><code>aftr-addr</code></em>  [<em class="replaceable"><code>command</code></em>]</p></div>
</div>
<div class="refsect1" title="OPTIONS">
<a name="id2676352"></a><h2>OPTIONS</h2>
<div class="variablelist"><dl>
<dt><span class="term">aftr-addr</span></dt>
<dd><p>
	    This is the address (IPv4 or IPv6) the the target AFTR.
          </p></dd>
</dl></div>
</div>
<div class="refsect1" title="COMMANDS">
<a name="id2714634"></a><h2>COMMANDS</h2>
<div class="variablelist"><dl>
<dt><span class="term">create 
	  <em class="replaceable"><code>user-ipv6</code></em>
	  <em class="replaceable"><code>protocol</code></em>
	  <em class="replaceable"><code>src-ipv4</code></em>
	  <em class="replaceable"><code>src-port</code></em>
	  <em class="replaceable"><code>nat-ipv4</code></em>
	  <em class="replaceable"><code>nat-port</code></em>
	</span></dt>
<dd><p>
	    This requests the aftr to create a port mapping.
          </p></dd>
<dt><span class="term">create 
	  <em class="replaceable"><code>user-ipv6</code></em>
	  <em class="replaceable"><code>nat-ipv4</code></em>
	</span></dt>
<dd><p>
	    This requests the aftr to create a tunnel entry,
	    using <em class="replaceable"><code>nat-ipv4</code></em> as the natted
	    IPv4 address for all future port mappings on this tunnel
	    (dynamic as well as static).
          </p></dd>
<dt><span class="term">delete
	  <em class="replaceable"><code>user-ipv6</code></em>
	  <em class="replaceable"><code>protocol</code></em>
	  <em class="replaceable"><code>src-ipv4</code></em>
	  <em class="replaceable"><code>src-port</code></em>
	  <em class="replaceable"><code>nat-ipv4</code></em>
	  <em class="replaceable"><code>nat-port</code></em>
	</span></dt>
<dd></dd>
<dt><span class="term">delete
	  <em class="replaceable"><code>user-ipv6</code></em>
	  <em class="replaceable"><code>protocol</code></em>
	  <em class="replaceable"><code>src-ipv4</code></em>
	  <em class="replaceable"><code>src-port</code></em>
	</span></dt>
<dd></dd>
<dt><span class="term">delete
	  <em class="replaceable"><code>protocol</code></em>
	  <em class="replaceable"><code>nat-ipv4</code></em>
	  <em class="replaceable"><code>nat-port</code></em>
	</span></dt>
<dd><p>
	    These three forms of the <strong class="userinput"><code>delete</code></strong>
	    command all request the aftr to delete a port mapping.
	    The mapping can be fully specified (first form), but a
	    mapping can also be uniquely identifed by either internal
	    parameters (second form) or external parameters (third
	    form).
          </p></dd>
<dt><span class="term">delete
	  <em class="replaceable"><code>user-ipv6</code></em>
	</span></dt>
<dd><p>
	    This requests the aftr to delete all port mappings
	    (dynamic as well as static) and other state associated
	    with the given tunnel address.  This is often done prior
	    to moving the customer to a new natted IPv4 address.
          </p></dd>
<dt><span class="term">flush</span></dt>
<dd><p>
	    This requests the aftr to remove all static port mappings
	    and configured tunnel entries.  Note that this is a very
	    drastic action, and should only be undertaken if (for
	    example) the aftr configuration is seriously out of sync
	    with the provisioning system.
          </p></dd>
<dt><span class="term">get <em class="replaceable"><code>user-ipv6</code></em></span></dt>
<dd><p>
	    This requests the aftr to report all static port mappings
	    associated with the given tunnel address.
          </p></dd>
<dt><span class="term">get</span></dt>
<dd><p>
	    This requests the aftr to report all static port mappings,
	    and all configured tunnels without static port mappings.
          </p></dd>
</dl></div>
</div>
<div class="refsect1" title="SCRIPTING">
<a name="id2689156"></a><h2>SCRIPTING</h2>
<p>
      If no commands are given on the command line,
      <span class="command"><strong>xmlclient.py</strong></span> will read commands from
      stdin.  This allows the provisioning system to accumulate
      changes for a given AFTR, and send them all at once.
    </p>
<p>
      In general, it is probably easier for the provisioning system to
      send requests immediately, and get replies immediately.
      However, some operators may prefer to batch up requests, and
      this method sends multiple requests over an open connection,
      without having to establish a connection for each request.
    </p>
<p>
      Example:<br>
      <strong class="userinput"><code>xmlclient.py 2001::500 &lt;script</code></strong>
    </p>
<p>
      where <code class="filename">script</code> contains:<br>
      <strong class="userinput"><code>create 2001::525a:8c5a:30d4:e36e tcp 192.168.0.88 6265 198.18.200.174 5005</code></strong><br>
      <strong class="userinput"><code>create 2001::835c:1eff:8d66:22fc tcp 192.168.1.138 3877 198.18.200.121 5572</code></strong><br>
      <strong class="userinput"><code>create 2001::e3:9a2f:8abf:40de:2d87 udp 192.168.0.92 7356 198.18.200.149 5547</code></strong><br>
    </p>
</div>
<div class="refsect1" title="SEE ALSO">
<a name="id2689232"></a><h2>SEE ALSO</h2>
<p>
    <span class="citerefentry"><span class="refentrytitle">xmlconf</span>(8)</span>
    </p>
</div>
<div class="refsect1" title="AUTHOR">
<a name="id2689255"></a><h2>AUTHOR</h2>
<p><span class="corpauthor">Internet Systems Consortium</span></p>
</div>
</div>
</div>
</div>
<div class="chapter" title="Chapter 6. Advanced Topics">
<div class="titlepage"><div><div><h2 class="title">
<a name="id2664853"></a>Chapter 6. Advanced Topics</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="#id2664858">6.1. No-Nat/Pass-Through</a></span></dt>
<dt><span class="sect1"><a href="#id2664921">6.2. A+P/Port-Range Routing</a></span></dt>
<dt><span class="sect1"><a href="#id2664989">6.3. Sharing a Single Address</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="#id2665142">6.3.1. For netfilter/iptables Wizards</a></span></dt></dl></dd>
</dl>
</div>
<div class="sect1" title="6.1. No-Nat/Pass-Through">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664858"></a>6.1. No-Nat/Pass-Through</h2></div></div></div>
<p>
        In a world where IPv4 address sharing is the norm, one might
        imagine that some customers would be willing to pay a little
        more for a full, non-shared global IPv4 prefix or address
        (i.e., a /32 prefix).
      </p>
<p>
        In this case, the customer would perform the NAT function in
        his own CPE, but he would still have to tunnel IPv4 traffic
        through the provider's IPv6-only network to the AFTR.
      </p>
<p>
        As yet, there is no defined signalling for the client to
        request a non-shared IPv4 prefix, or for the server to
        establish a non-natted tunnel.  All configuration must be done
        manually, on both the B4 and the AFTR.
      </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
            On the B4, the tunnel will still have to be set up, and
            all IPv4 traffic will have to be routed to the tunnel, but
            only after the local NAT function is performed.
          </p></li>
<li class="listitem"><p>
            On the AFTR, a <span class="command"><strong>nonat</strong></span> command will have
            to be entered in <code class="filename">aftr.conf</code>, and a
            route to the customer's IPv4 prefix will have to be
            created in
            <code class="filename">aftr-script</code>.
          </p></li>
</ul></div>
</div>
<div class="sect1" title="6.2. A+P/Port-Range Routing">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664921"></a>6.2. A+P/Port-Range Routing</h2></div></div></div>
<p>
        A+P is a different approach to IPv4 address sharing, described
        in <code class="filename">draft-ymbk-aplusp-05.txt</code>.  In this
        scenario, each customer is provisioned with a global IPv4
        address, but only a restricted range of ports he can use
        within that address.
      </p>
<p>
        Similar to the no-nat case above, the customer would perform
        the NAT function within his own CPE (ensuring that all port
        mappings are within the provisioned range), but he would still
        have to tunnel IPv4 traffic through the provider's IPv6-only
        network to the AFTR.
      </p>
<p>
        As yet, there is no defined signalling for the client to
        request an A+P assignment, or for the server to
        establish a non-natted tunnel.  All configuration must be done
        manually, on both the B4 and the AFTR.
      </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
            On the B4, the tunnel will still have to be set up, and
            all IPv4 traffic will have to be routed to the tunnel, but
            only after the local NAT function is performed.
          </p></li>
<li class="listitem"><p>
            On the AFTR, a <span class="command"><strong>prr</strong></span> command will have to
            be entered in <code class="filename">aftr.conf</code>, and a route
            to the customer's IPv4 address will have to be created in
            <code class="filename">aftr-script</code>.
          </p></li>
</ul></div>
</div>
<div class="sect1" title="6.3. Sharing a Single Address">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="id2664989"></a>6.3. Sharing a Single Address</h2></div></div></div>
<p>
        In production use, an AFTR will have a pool of global IPv4
        addresses that are used exclusively for natted port mappings.
      </p>
<p>
        However, for testing or demonstration purposes, you may want
        to deploy AFTR on a box with only one IPv4 address:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
            This address is used for standard services of the box.
          </p></li>
<li class="listitem"><p>
            This address is used by application proxies etc., in
            particular the DNS caching server.
          </p></li>
<li class="listitem"><p>
            This address is used to NAT traffic, i.e., for the AFTR
            function.
          </p></li>
</ul></div>
<p>
        The address can be dynamic (provisioned by DHCP), but must not
        change during an AFTR process run.
      </p>
<p>
        The AFTR box is configured to use the eth0 interface on the
        WAN side, the eth1 on the LAN side. The AFTR process itself is
        configured as usual, but it uses a pseudo-public address
        (i.e., an address which is not recognized as private but in
        fact is a reserved public address, the first to avoid
        confusion, the second to avoid a collision with a real public
        address).
      </p>
<p>
        Netfilter/iptables is used to map the pseudo-public address to
        the real public address. Port forwarding is a bit more
        complex, as the port range used for port forwarding must be
        port-forwarded (destination natted in netfilter/iptables
        terms) as-is (i.e., not changing ports) to the pseudo-public
        address.  Of course there is nothing which can be done for
        no-NATs or for A+P/PRR as the first router/NAT of the Internet
        connection has no reason to support it.
      </p>
<p>
        Note that this creates a double-NAT situation within the AFTR
        box: customer traffic is natted once in the AFTR itself, to
        the pseudo-public address, then a second time in netfilter, to
        the real public address.  This is obviously not ideal from a
        performance perspective, but this scenario is only for testing
        and demonstration purposes.
      </p>
<p>
        For the AFTR box itself configuration should be:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
            Use the standard setup for eth0 (i.e., plain DHCP).
          </p></li>
<li class="listitem"><p>
            Use the standard setup for the AFTR function, only the
            script needs to be special.
          </p></li>
<li class="listitem"><p>
            IPv4 forwarding must be enabled.
          </p></li>
<li class="listitem"><p>
            Don't forget to flush iptables and ip6tables.
          </p></li>
</ul></div>
<p>
        Use or adapt the example <code class="filename">aftr.conf</code> and
        <code class="filename">aftr-script</code> files from the 
        <code class="filename">conf/shareone</code> directory.  (They use
        198.18.200.111 as the pseudo-public address and 5000-59999 TCP
        and UDP port ranges for dynamic NAT bindings.)
      </p>
<p>
        If the kernel supports it (see <span class="command"><strong>iptables</strong></span>
        SNAT section) it can be useful to add
        <strong class="userinput"><code>--random</code></strong> to the SNAT rule in order to
        get back port randomization.
      </p>
<div class="sect2" title="6.3.1. For netfilter/iptables Wizards">
<div class="titlepage"><div><div><h3 class="title">
<a name="id2665142"></a>6.3.1. For netfilter/iptables Wizards</h3></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
              <strong class="userinput"><code>$PUBLIC</code></strong> is the shared real public
              address, it is taken from the eth0 configuration.
            </p></li>
<li class="listitem"><p>
              The flush in <code class="function">stop</code> and at the
              beginning of <code class="function">start</code> is for cleaning
              NAT rules.
            </p></li>
<li class="listitem"><p>
              The SNAT rule just creates a new conntrack NAT entry for
              the first packet of a flow to the Internet coming from the
              AFTR. It adds no constraint on the protocol or the natted
              source port (but the AFTR has itself such constraints,
              protocols are tcp/udp/icmp-echo and the source port will
              be in the range declared in the pool so the natted port
              should be in one of the ranges decribed in
              <span class="command"><strong>iptables</strong></span> SNAT section).
            </p></li>
<li class="listitem"><p>
              The first DNAT rule remaps traffic to a matching port to
              the pseudo public address without changing the destination
              port. It is used for port forwarding.
            </p></li>
<li class="listitem"><p>
              Destination ports are protocol specific so the rules have
              to be duplicated from TCP to UDP.
            </p></li>
<li class="listitem"><p>
              Locally generated traffic doesn't go through PREROUTING,
              so the rules have to be duplicated from PREROUTING to
              OUTPUT.
            </p></li>
</ul></div>
<p>
          Don't forget that with conntrack a NAT entry matches the both
          ways, so what matters is the processing of the first packet of
          a flow. Further packets are recognized by conntrack to belong
          to the same flow, including in the "reverse" way, and the NAT
          rule is applied (the symmetrical rule for reverse way
          packets). And conntrack is also used to recognize local
          traffic.
        </p>
</div>
</div>
</div>
<div class="appendix" title="Appendix A. Mailing Lists">
<div class="titlepage"><div><div><h2 class="title">
<a name="id2662490"></a>Appendix A. Mailing Lists</h2></div></div></div>
<p>
      Bug reports should be sent to: <code class="email">&lt;<a class="email" href="mailto:aftr-bugs@isc.org">aftr-bugs@isc.org</a>&gt;</code>
    </p>
<p>
      General questions or feedback (e.g., about configuration,
      operation, or use cases) should be sent to:
      <code class="email">&lt;<a class="email" href="mailto:aftr-users@isc.org">aftr-users@isc.org</a>&gt;</code>
    </p>
</div>
</div></body>
</html>
